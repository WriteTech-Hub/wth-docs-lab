name: Validate PR

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write   # to post comments
      contents: read

    steps:
      - name: Validate PR content
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';

            const missing = [];

            // ------- 1. Validate PR TYPE section ---------------------------
            // Extract the text between "### 📝 PR Type" and the next heading.
            const prTypeMatch = prBody.match(/###\s*[^#]*PR Type([\s\S]*?)(?:###|$)/i);
            const prTypeSection = prTypeMatch ? prTypeMatch[1] : '';
            const hasCheckedType = /[-*]\s+\[(x|X)\]/.test(prTypeSection);

            if (!hasCheckedType) {
              missing.push('No PR type selected in the checklist.');
            }

            // ------- 2. Validate docs checklist if needed -------------------
            const needsDocs = /This PR \*\*requires\*\* documentation/i.test(prBody);

            if (needsDocs) {
              if (!/\* \[x\] I have added the `needs-docs` label/i.test(prBody)) {
                missing.push('Missing check: `needs-docs` label not confirmed.');
              }
              if (!/\* \[x\] A documentation ticket has been created/i.test(prBody)) {
                missing.push('Missing check: Documentation ticket not marked as created.');
              }
              if (!/\* \[x\] The ticket has been assigned to the docs team/i.test(prBody)) {
                missing.push('Missing check: Documentation ticket not marked as assigned.');
              }
            }

            // ------- 3. Report results --------------------------------------
            if (missing.length > 0) {
              const commentBody = `
              🚫 **PR Template Validation Failed**

              The following required checklist items are missing:

              ${missing.map(m => `- ${m}`).join('\n')}

              Please update the PR description and re-check.
              _This check will re-run automatically on the next commit or edit._
              `.trim();

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: commentBody,
              });

              core.setFailed('PR template validation failed. See PR comments for details.');
            } else {
              console.log('PR template is valid ✅');
            }
